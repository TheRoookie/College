CREATE TABLE employee_details(emp_id int PRIMARY KEY, f_name varchar(30) NOT NULL, l_name varchar(30) NOT NULL, 
				email varchar(50), phone_no bigint, company_name varchar(50) NOT NULL, 
				city varchar(30), joining_date date NOT NULL, salary numeric NOT NULL);

INSERT INTO employee_details VALUES (531539 , 'Shailesh' , 'Godiyal' , 'shailesh0786@gmail.com' , 9762720722 , 'Aditya Birla Finance Limited' , 'Mumbai' , '2015-03-23' , 33400),
				(648009 , 'Siddhesh' , 'Kalambe' , 'siddhesh9224@gmail.com' ,9168660058 , 'Tata Steel Limited' , 'Jamshedpur' , '2010-03-03' , 35700),
				(470123 , 'Narendra' , 'Modi' , 'narendra95@gmail.com' , 9764930604 , 'Bajaj Auto Limited' , 'Pune' , '2016-05-05' , 34800),
				(768534 , 'Aditya' , 'Yeraple' , 'aditya123gupta@gmail.com' , 7743984045 , 'Bharat Petroleum Corporation Limited' , 'Kochi' , '2011-10-02' , 39000),
				(307899 , 'Mahesh' , 'Tiwari' , 'tiwari123@yahoo.in' , 9421526763 , 'Nj Mutual Fund' , 'Surat' , '2021-12-01' , 29000),
				(531579 , 'Sagar' , 'Gupta' , 'sagar65786@gmail.com' , 9890963391 , 'Aditya Birla Finance Limited' , 'Mumbai' , '2019-09-04' , 41040),
				(768519 , 'Vaibhav' , 'Gupta' , 'contact.gupta@gmail.com' , '9987458791' , 'Bharat Petroleum Corporation Limited' , 'Kochi' , '2015-01-07' , 38450),
				(307889 , 'Dhruv' , 'Patel' , 'dhruv88@gmail.com' , 9566784460 , 'Nj Mutual Fund' , 'Surat' , '2020-05-21' , 36290),
				(648780 , 'Vikas' , 'Patel' , 'vikas2307@gmail.com' , 8870851599 , 'Tata Steel Limited' , 'Jamshedpur' , '2019-09-11' , 37080),
				(307890 , 'Vivek' , 'Chalke' , 'vivek1056@gmail.com' , 9971461601 , 'Nj Mutual Fund' , 'Surat' , '2019-09-04' , 33170),
				(470543 , 'Akash' , 'Pawar' , 'akash307@gmail.com' , 9733828288 , 'Bajaj Auto Limited' , 'Pune' , '2022-08-04' , 42340),
				(470850 , 'Dhara' , 'Desai' , 'desai6784@gmail.com' , 8762446348 , 'Bajaj Auto Limited' , 'Pune' , '2019-09-09' , 31000),
				(531509 , 'Bhavesh' , 'Patil' , 'bhavesh110@yahoo.com' , 8298960655 , 'Aditya Birla Finance Limited' , 'Mumbai' , '2021-08-16' , 32700),
				(307811 , 'Gaurav' , 'Malshikare' , 'gaurav1786@gmail.com' , 9481945073 , 'Nj Mutual Fund','Surat' , '2016-06-08' , 37690),
				(768585 , 'Dilip' , 'Kumar' , 'kumar.dilip@gmail.com' , 7892027512 , 'Bharat Petroleum Corporation Limited' , 'Kochi' , '2019-05-09' , 38020),
				(470590 , 'Divashu' , 'Tyagi' , 'tyagi893@gmail.com' , 7045643532 , 'Bajaj Auto Limited' , 'Pune' , '2020-12-08' , 35120),
				(648076 , 'Bhaskar' , 'Kalita' , 'bhaskar@gmail.com' , 9629755440 , 'Tata Steel Limited' , 'Jamshedpur' , '2011-11-08' , 32950),
				(768520 , 'Tushar' , 'Shukla' , 'tushar1990@gmail.com' , 8792514853 , 'Bharat Petroleum Corporation Limited' , 'Kochi' , '2013-09-21' , 35890),
				(531522 , 'Parvathi' , 'Sugathan' , 'parvathi94@gmail.com' , 9967176168 , 'Aditya Birla Finance Limited' , 'Mumbai' , '2012-12-23' , 34000),
				(768500 , 'Aakarsh' , 'Mahajan' , 'aakarsh99@gmail.com' , 7208346567 , 'Bharat Petroleum Corporation Limited' , 'Kochi' , '2014-10-16' , 32720),					
				(768599 , 'Rakhi' , 'Rawat' , 'naveen2010@hotmail.com' , 9067780978 , 'Bharat Petroleum Corporation Limited' , 'Kochi' , '2021-12-21' , 43530),
				(531505 , 'Sanchit' , 'Bhole' , 'sanchit3647@gmail.com' , 7304760952 , 'Aditya Birla Finance Limited' , 'Mumbai' , '2013-09-09' , 34900),
				(307801 , 'Vikas' , 'Chaubey' , 'vikas.isg@gmail.com' , 8291770823 , 'Nj Mutual Fund' , 'Surat' , '2017-01-04' , 33430),
				(470200 , 'Bipin' , 'Pandey' , 'bipin7589@gmail.com' , 9920720210 , 'Bajaj Auto Limited' , 'Pune' , '2013-01-01' , 31200),
				(307898 , 'Himanshu' , 'Pandey' , 'pandey.j09@gmail.com' , 8369030315 , 'Nj Mutual Fund' , 'Surat' , '2022-01-19' , 32000),
				(648800 , 'Akash' , 'Male' , 'akash.sept28@gmail.com' , 9827242666 , 'Tata Steel Limited' , 'Jamshedpur' , '2020-12-14' , 39540),
				(531598 , 'Sunita' , 'Kumar' , 'sunita5768@gmail.com' , 7738741589 , 'Aditya Birla Finance Limited' , 'Mumbai' , '2022-02-17' , 39240),
				(648308 , 'Dheeraj' , 'Sarkar' , 'dheeraj@gmail.com' , 8277499889 , 'Tata Steel Limited' , 'Jamshedpur' , '2014-07-16' , 37200),
				(470800 , 'Parul' , 'Gera' , 'parul1134@gmail.com' , 8080150567 , 'Bajaj Auto Limited' , 'Pune' , '2022-12-01' , 36250),
				(648210 , 'Rajesh' , 'Kumar' , 'krajesh123@gmail.com' , 9876534236 , 'Tata Steel Limited' , 'Jamshedpur' , '2012-12-05' , 36130);
--SELECT * FROM employee_details;
--DROP TABLE employee_details;

CREATE TABLE company_details(company_name varchar(50) PRIMARY KEY, locationo varchar(30), industry varchar(30), 
				working_days int);
INSERT INTO company_details VALUES ('Aditya Birla Finance Limited' , 'Mumbai' , 'Financial Services' , 26),
			('Tata Steel Limited' , 'Jamshedpur' , 'Mining' , 26),
			('Bajaj Auto Limited' , 'Pune' , 'Automotive' , 26),
			('Bharat Petroleum Corporation Limited' , 'Kochi' , 'Oil and Gas' , 26),
			('Nj Mutual Fund' , 'Surat' , 'Finnacial Services' , 26);
--SELECT * FROM company_details;
--DROP TABLE company_details;


CREATE TABLE final_table1 AS(SELECT emp_id, f_name, l_name, company_name, salary FROM employee_details
				WHERE (SELECT EXTRACT(YEAR FROM current_date) - EXTRACT(YEAR FROM joining_date)) > 5);
ALTER TABLE final_table1 ADD  years_worked numeric, ADD da numeric, ADD description varchar(100), ADD gratuity_amt numeric ;--*********
--SELECT * FROM final_table1;
--DROP TABLE final_table1;

CREATE TABLE final_table2 AS(SELECT emp_id, f_name, l_name, company_name, salary FROM employee_details
				WHERE (SELECT EXTRACT(YEAR FROM current_date) - EXTRACT(YEAR FROM joining_date)) < 5);
ALTER TABLE final_table2 ADD  years_worked numeric, ADD description varchar(100);
--SELECT * FROM final_table2;
--DROP TABLE final_table2;

CREATE OR REPLACE PROCEDURE cal_amt(j_d date, total_year INOUT numeric, salary numeric, da INOUT numeric, w_d int, final_amt INOUT numeric, f_statement INOUT varchar(100))
AS $$ --**********
DECLARE
total_salary numeric;
BEGIN
	total_year := EXTRACT(YEAR FROM CURRENT_TIMESTAMP) - EXTRACT(YEAR FROM j_d);
	IF total_year > 5 THEN
		da := salary * 0.42;
		total_salary := salary + da;
		final_amt := (total_salary * 15.0 * total_year) / w_d;
		f_statement = 'The employee is eligible to get gratuity';
	ELSE
		da = 0;
		final_amt = 0;
		f_statement = 'The employee is *NOT* eligible to get gratuity';
	END IF;
END;
$$
LANGUAGE PLPGSQL;

--DROP PROCEDURE cal_amt;

CREATE OR REPLACE PROCEDURE insert_final_data(e_id int, years numeric, da1 numeric, f_statement varchar(100), final_amt numeric)
AS $$
BEGIN
	IF final_amt > 0 AND da1 > 0 THEN
		UPDATE final_table1 SET years_worked = years, da = da1, description = f_statement, gratuity_amt = final_amt WHERE emp_id = e_id;
	ELSE
		UPDATE final_table2 SET years_worked = years, description = f_statement WHERE emp_id = e_id;
	END IF;
END;
$$
LANGUAGE PLPGSQL;


DO
$$
DECLARE
	e_id employee_details.emp_id %TYPE;
	e_salary employee_details.salary %TYPE;
	j_d employee_details.joining_date %TYPE;
	w_d company_details.Working_days %TYPE;
	da numeric;
	total_year numeric;
	final_amt numeric;-- *****
	f_statement varchar(100);
	e_cursor CURSOR FOR SELECT emp_id, salary, joining_date, working_days FROM employee_details INNER JOIN company_details 
						ON employee_details.company_name = company_details.company_name;
BEGIN
	OPEN e_cursor;
		LOOP
			FETCH e_cursor INTO e_id, e_salary, j_d, w_d;
			EXIT WHEN NOT FOUND;
			CALL cal_amt(j_d, total_year, e_salary, da, w_d, final_amt, f_statement);
			CALL insert_final_data(e_id, total_year, da, f_statement, final_amt);
		END LOOP;
	CLOSE e_cursor;
END;
$$
LANGUAGE PLPGSQL;

--SELECT * FROM final_table1 join final_table2 on true;
SELECT emp_id , f_name , l_name , company_name , salary , years_worked , description from final_table1 union SELECT emp_id , f_name , l_name , company_name , salary , years_worked , description from final_table2;